# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: CI

on:
  workflow_dispatch:
    inputs:
      build_configuration:
        type: choice
        description: Build configuration
        options: 
        - Debug
        - Release
        required: true
        default: 'Debug'
      run_build:
        type: boolean
        description: Run build
        required: true
        default: true
      run_tests:
        type: boolean
        description: Run tests
        required: true
        default: true
      run_docker:
        type: boolean
        description: Run docker tests
        required: true
        default: true
      generate_assets:
        type: boolean
        description: Generate assets from test runs
        required: true
        default: false
      publish_testresults:
        type: boolean
        description: Publish test results
        required: true
        default: true
      generate_sbom:
        type: boolean
        description: Generate SBOM (CycloneDX)
        required: true
        default: true
      run_lint:
        type: boolean
        description: Run linting
        required: true
        default: true
      run_sonarcloud:
        type: boolean
        description: Run SonarCloud
        required: true
        default: true
  push:
    branches:
      - 'master'
  pull_request:
    branches:
      - '**'

jobs:
  dependency-review:
    name: Dependency review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Dependency review
        uses: actions/dependency-review-action@v4
  dependency-submission:
    name: Dependency submission
    runs-on: windows-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
    permissions:
      contents: write
      id-token: write
    env:
      DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.x
            9.x
            10.x
          dotnet-quality: 'ga'
      - name: Setup .NET workloads
        run: >
          dotnet workload install
          maui-android
          maui-ios
          maui-maccatalyst
          maui-windows
          wasm-tools
      - name: Restore
        run: dotnet restore src/PDFtoImage.Build.slnf
      - name: Component detection
        uses: advanced-security/component-detection-dependency-submission-action@d433c2f467e149a8009c8fbce92cc708ed15ef7b
        with:
          detectorsCategories: "NuGet"
  lint:
    name: Lint
    runs-on: windows-latest
    if: (github.event_name != 'workflow_dispatch' && true || inputs.run_lint) == true
    permissions:
      contents: read
    env:
      DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.x
            9.x
            10.x
          dotnet-quality: 'ga'
      - name: Setup .NET workloads
        run: >
          dotnet workload install
          maui-android
          maui-ios
          maui-maccatalyst
          maui-windows
          wasm-tools
      - name: Restore
        run: dotnet restore src/PDFtoImage.Build.slnf
      - name: Format
        run: dotnet format src/PDFtoImage.Build.slnf --verify-no-changes
  sbom:
    name: SBOM (CycloneDX)
    runs-on: windows-latest
    if: ((github.event_name != 'workflow_dispatch' && true || inputs.generate_sbom) == true) && github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
    permissions:
      contents: read
      id-token: write
      attestations: write
    env:
      DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.x
            9.x
            10.x
          dotnet-quality: 'ga'
      - name: Setup .NET workloads
        run: >
          dotnet workload install
          maui-android
          maui-ios
          maui-maccatalyst
          maui-windows
          wasm-tools
      - name: Restore
        run: dotnet restore src/PDFtoImage.Build.slnf
      - name: Install CycloneDX tool
        shell: bash
        run: |
          dotnet tool install --tool-path ./.tools CycloneDX
          echo "${{ github.workspace }}/.tools" >> $GITHUB_PATH
      - name: Generate SBOM (CycloneDX JSON)
        shell: bash
        run: |
          mkdir -p artifacts/sbom
          dotnet-CycloneDX src/PDFtoImage.Build.slnf -o artifacts/sbom -F Json -fn bom.json
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v6
        with:
          name: sbom-cyclonedx
          path: artifacts/sbom/bom.json
          if-no-files-found: error
  build:
    name: Build
    runs-on: windows-latest
    env:
      DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: "true"
    if: (github.event_name != 'workflow_dispatch' && true || inputs.run_build) == true
    permissions:
      id-token: write
      contents: read
      attestations: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.x
            9.x
            10.x
          dotnet-quality: 'ga'
      - name: Setup .NET workloads
        run: >
          dotnet workload install
          maui-android
          maui-ios
          maui-maccatalyst
          maui-windows
          wasm-tools
      - name: Restore
        run: dotnet restore src/PDFtoImage.Build.slnf
      - name: Build
        run: dotnet build src/PDFtoImage.Build.slnf -c ${{ github.event_name != 'workflow_dispatch' && 'Debug' || inputs.build_configuration }} -p:VersionSuffix=ci --no-restore
      - name: Pack
        run: dotnet pack src/PDFtoImage/PDFtoImage.csproj -c ${{ github.event_name != 'workflow_dispatch' && 'Debug' || inputs.build_configuration }} -p:VersionSuffix=ci --no-restore
      - name: Generate artifact attestation
        if: github.repository == 'sungaila/PDFtoImage' && github.ref == 'refs/heads/master'
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: src/PDFtoImage/bin/${{ github.event_name != 'workflow_dispatch' && 'Debug' || inputs.build_configuration }}/*.nupkg
      - name: Publish libraries
        uses: actions/upload-artifact@v6
        with:
          name: Library assemblies
          path: |
            src/PDFtoImage/bin/${{ github.event_name != 'workflow_dispatch' && 'Debug' || inputs.build_configuration }}
            !**/*.nupkg
            !**/*.snupkg
          if-no-files-found: error
      - name: Publish NuGet packages
        uses: actions/upload-artifact@v6
        with:
          name: NuGet packages
          path: |
            src/PDFtoImage/bin/${{ github.event_name != 'workflow_dispatch' && 'Debug' || inputs.build_configuration }}/*.nupkg
            src/PDFtoImage/bin/${{ github.event_name != 'workflow_dispatch' && 'Debug' || inputs.build_configuration }}/*.snupkg
          if-no-files-found: error
      - name: Publish tests
        uses: actions/upload-artifact@v6
        if: success() && (github.event_name != 'workflow_dispatch' && true || inputs.run_tests) == true
        with:
          name: Test assemblies
          path: src/Tests/bin/${{ github.event_name != 'workflow_dispatch' && 'Debug' || inputs.build_configuration }}
          if-no-files-found: error
          retention-days: 1
          compression-level: 9
  test:
    permissions:
      contents: read
    name: Test (${{ matrix.os }})
    needs: build
    strategy:
      fail-fast: false
      matrix:
        os: [windows-11-arm, windows-2022, windows-2025, ubuntu-22.04, ubuntu-24.04, ubuntu-24.04-arm, macos-14, macos-15, macos-15-intel, macos-26]
    runs-on: ${{ matrix.os }}
    env:
      DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: "true"
    if: success() && (github.event_name != 'workflow_dispatch' && true || inputs.run_tests) == true
    steps:
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.x
            9.x
            10.x
          dotnet-quality: 'ga'
      - name: Download test assemblies
        if: (success() || failure())
        uses: actions/download-artifact@v7
        with:
          name: Test assemblies
      - name: .NET Framework 4.7.1
        if: runner.os == 'Windows' && (success() || failure())
        run: dotnet test net471/*.Tests.dll --logger trx --verbosity detailed --results-directory "${{ matrix.os }}/TestResults" ${{ (github.event_name == 'workflow_dispatch' && inputs.generate_assets) == true && '--settings net471/SaveOutputInGeneratedFolder.runsettings' || '' }}
      - name: .NET Framework 4.8.1
        if: runner.os == 'Windows' && (success() || failure())
        run: dotnet test net481/*.Tests.dll --logger trx --verbosity detailed --results-directory "${{ matrix.os }}/TestResults" ${{ (github.event_name == 'workflow_dispatch' && inputs.generate_assets) == true && '--settings net481/SaveOutputInGeneratedFolder.runsettings' || '' }}
      - name: .NET 8
        if: success() || failure()
        run: dotnet test net8.0/*.Tests.dll --logger trx --verbosity detailed --results-directory "${{ matrix.os }}/TestResults" ${{ (github.event_name == 'workflow_dispatch' && inputs.generate_assets) == true && '--settings net8.0/SaveOutputInGeneratedFolder.runsettings' || '' }}
      - name: .NET 9
        if: success() || failure()
        run: dotnet test net9.0/*.Tests.dll --logger trx --verbosity detailed --results-directory "${{ matrix.os }}/TestResults" ${{ (github.event_name == 'workflow_dispatch' && inputs.generate_assets) == true && '--settings net9.0/SaveOutputInGeneratedFolder.runsettings' || '' }}
      - name: .NET 10
        if: success() || failure()
        run: dotnet test net10.0/*.Tests.dll --logger trx --verbosity detailed --results-directory "${{ matrix.os }}/TestResults" ${{ (github.event_name == 'workflow_dispatch' && inputs.generate_assets) == true && '--settings net10.0/SaveOutputInGeneratedFolder.runsettings' || '' }}
      - name: Upload test results
        if: success() || failure()
        uses: actions/upload-artifact@v6
        with:
          name: Test results (${{ matrix.os }})
          path: ./**/*.trx
          if-no-files-found: error
          retention-days: 1
      - name: Upload generated assets
        if: (success() || failure()) && (github.event_name == 'workflow_dispatch' && inputs.generate_assets) == true
        uses: actions/upload-artifact@v6
        with:
          name: Generated assets (${{ matrix.os }})
          path: ./**/Assets/Generated
          if-no-files-found: error
          retention-days: 1
  docker-linux:
    permissions:
      contents: read
    name: Docker (Linux)
    runs-on: ubuntu-latest
    if: success() && (github.event_name != 'workflow_dispatch' && true || inputs.run_docker) == true
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          sparse-checkout: |
            src/PDFtoImage
            src/FrameworkTests/AotConsole
            src/Tests/Assets/SocialPreview.pdf
      - name: console (alpine)
        if: success() || failure()
        run: docker buildx build -t console -f src/FrameworkTests/AotConsole/Dockerfiles/alpine.dockerfile . && docker run --rm console
      - name: console (alpine-aot)
        if: success() || failure()
        run: docker buildx build -t console -f src/FrameworkTests/AotConsole/Dockerfiles/alpine-aot.dockerfile . && docker run --rm console
      - name: console (ubuntu)
        if: success() || failure()
        run: docker buildx build -t console -f src/FrameworkTests/AotConsole/Dockerfiles/ubuntu.dockerfile . && docker run --rm console
      - name: console (ubuntu-chiseled)
        if: success() || failure()
        run: docker buildx build -t console -f src/FrameworkTests/AotConsole/Dockerfiles/ubuntu-chiseled.dockerfile . && docker run --rm console
      - name: console (ubuntu-aot)
        if: success() || failure()
        run: docker buildx build -t console -f src/FrameworkTests/AotConsole/Dockerfiles/ubuntu-aot.dockerfile . && docker run --rm console
      - name: console (ubuntu-chiseled-aot)
        if: success() || failure()
        run: docker buildx build -t console -f src/FrameworkTests/AotConsole/Dockerfiles/ubuntu-chiseled-aot.dockerfile . && docker run --rm console
  docker-windows:
    permissions:
      contents: read
    name: Docker (Windows)
    runs-on: windows-2025
    if: success() && (github.event_name != 'workflow_dispatch' && true || inputs.run_docker) == true
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          sparse-checkout: |
            src/PDFtoImage
            src/FrameworkTests/AotConsole
            src/Tests/Assets/SocialPreview.pdf
      - name: console (windows-servercore)
        if: success() || failure()
        run: docker build -t console -f src\FrameworkTests\AotConsole\Dockerfiles\windows-servercore.dockerfile . && docker run --rm console
      - name: Setup MSVC Developer Command Prompt
        if: success() || failure()
        uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756
        with:
          arch: x64
      - name: Setup .NET
        if: runner.os == 'Windows'
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            10.x
          dotnet-quality: 'ga'
      - name: Publish AOT (win-x64, self-contained)
        run: |
          dotnet restore "src\FrameworkTests\AotConsole\AotConsole.csproj" -r win-x64 -p:TargetFramework=net10.0
          dotnet publish "src\FrameworkTests\AotConsole\AotConsole.csproj" -c Release -r win-x64 -p:PublishAot=true -p:SelfContained=true -p:StripSymbols=true -o $env:GITHUB_WORKSPACE\artifacts\win-x64-aot --no-restore
      - name: console (windows-servercore-aot)
        run: docker build -t console -f src\FrameworkTests\AotConsole\Dockerfiles\windows-servercore-aot.dockerfile --build-arg PUBLISH_DIR="artifacts/win-x64-aot" . && docker run --rm console
  publish-test-results:
    name: Publish tests results
    needs: test
    runs-on: ubuntu-latest
    permissions:
      checks: write
      pull-requests: write
    concurrency:
      group: "publish-test-results"
      cancel-in-progress: false
    if: (success() || failure()) && (github.event_name != 'workflow_dispatch' && true || inputs.publish_testresults) == true
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: Test results (*)
          merge-multiple: true
          path: artifacts
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@27d65e188ec43221b20d26de30f4892fad91df2f
        with:
          files: artifacts/**/*.trx
          check_name: Test results
          compare_to_earlier_commit: false
          action_fail_on_inconclusive: true
          json_file: test-results.json
      - name: Upload test results to GitHub Gist
        if: github.repository == 'sungaila/PDFtoImage' && github.ref == 'refs/heads/master' && success()
        uses: exuanbo/actions-deploy-gist@47697fceaeea2006a90594ee24eb9cd0a1121ef8
        with:
          token: ${{ secrets.GIST_TOKEN }}
          gist_id: 003e8ab2211221897e4b3c0e564ed7b6
          gist_description: ${{ github.repository }} test results as JSON
          gist_file_name: ${{ github.repository_owner }}_${{ github.event.repository.name }}_test-results.json
          file_path: test-results.json
          file_type: text
  sonarcloud:
    name: SonarCloud
    runs-on: windows-latest
    permissions:
      contents: read
      pull-requests: read
    env:
      DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: "true"
    if: (github.event_name != 'workflow_dispatch' || inputs.run_sonarcloud) == true
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.x
            9.x
            10.x
          dotnet-quality: 'ga'
      - name: Setup .NET workloads
        run: >
          dotnet workload install
          maui-android
          maui-ios
          maui-maccatalyst
      - name: Setup dotnet-coverage
        run: dotnet tool install --global dotnet-coverage
      - name: Setup JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: 17
          java-package: jdk
          distribution: 'zulu'
      - name: Install SonarCloud scanner
        shell: powershell
        run: |
          New-Item -Path .\.sonar\scanner -ItemType Directory
          dotnet tool update dotnet-sonarscanner --tool-path .\.sonar\scanner
      - name: Analyze
        if: env.SONAR_TOKEN != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        shell: powershell
        run: |
          .\.sonar\scanner\dotnet-sonarscanner begin /k:"sungaila_PDFtoImage" /o:"sungaila" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.cs.vscoveragexml.reportsPaths=coverage.xml
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

          dotnet build src/PDFtoImage.SonarCloud.slnf -c Debug
          dotnet-coverage collect "dotnet test src/PDFtoImage.SonarCloud.slnf --verbosity detailed" -f xml -o "coverage.xml"

          .\.sonar\scanner\dotnet-sonarscanner end
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }